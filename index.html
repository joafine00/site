<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GoToLinkUp - Link Shortener & QR Code (Beta)</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #121212;
    color: #eee;
    margin: 0; padding: 0;
  }
  header {
    background: #222;
    padding: 1rem 1.5rem;
    font-weight: bold;
    font-size: 1.2rem;
    color: #61dafb;
    user-select: none;
  }
  #app {
    max-width: 720px;
    margin: 2rem auto;
    padding: 1rem;
    background: #1e1e1e;
    border-radius: 8px;
  }
  label {
    display: block;
    margin-top: 1rem;
    font-weight: bold;
  }
  input[type=text], input[type=password] {
    width: 100%;
    padding: 0.5rem;
    font-size: 1rem;
    border-radius: 4px;
    border: none;
    margin-top: 0.3rem;
    background: #333;
    color: #eee;
  }
  input[type=checkbox] {
    margin-right: 0.5rem;
  }
  button {
    margin-top: 1rem;
    background: #61dafb;
    border: none;
    color: #121212;
    font-weight: bold;
    font-size: 1.1rem;
    padding: 0.7rem 1.2rem;
    border-radius: 6px;
    cursor: pointer;
  }
  button:hover {
    background: #21a1f1;
  }
  #message {
    margin-top: 1rem;
    color: #7efc82;
    font-weight: bold;
  }
  #error {
    margin-top: 1rem;
    color: #f44336;
    font-weight: bold;
  }
  #qrcode {
    margin-top: 1rem;
    text-align: center;
  }
  #linksList {
    margin-top: 2rem;
  }
  .link-item {
    background: #2a2a2a;
    padding: 0.7rem;
    border-radius: 6px;
    margin-bottom: 0.7rem;
  }
  .link-item strong {
    color: #61dafb;
  }
  .private-tag {
    color: #f44336;
    font-weight: bold;
    margin-left: 0.5rem;
  }
  .copy-btn {
    margin-left: 1rem;
    cursor: pointer;
    color: #ccc;
    font-size: 0.9rem;
  }
  .copy-btn:hover {
    color: #7efc82;
  }
  /* Access overlay */
  #accessOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(18,18,18,0.95);
    color: #eee;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    padding: 1rem;
  }
  #accessOverlay.active {
    display: flex;
  }
  #accessOverlay h2 {
    margin-bottom: 1rem;
    color: #61dafb;
  }
  #accessOverlay p {
    margin-bottom: 1rem;
    text-align: center;
  }
  #accessOverlay input[type=password] {
    font-size: 1.2rem;
    padding: 0.5rem;
    border-radius: 6px;
    border: none;
    margin-bottom: 1rem;
    background: #333;
    color: #eee;
  }
  #accessOverlay button {
    padding: 0.6rem 1.5rem;
    background: #61dafb;
    border: none;
    color: #121212;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
  }
  #accessOverlay button:hover {
    background: #21a1f1;
  }
  #accessError {
    color: #f44336;
    font-weight: bold;
    margin-top: 0.5rem;
  }
  #waitSpinner {
    border: 6px solid #2a2a2a;
    border-top: 6px solid #61dafb;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1.5s linear infinite;
    margin-bottom: 1rem;
  }
  @keyframes spin {
    0% {transform: rotate(0deg);}
    100% {transform: rotate(360deg);}
  }
</style>
</head>
<body>

<header>GoToLinkUp (Beta) - Link Shortener & QR Code Generator</header>

<div id="app">
  <label for="inputURL">Enter URL to shorten:</label>
  <input type="text" id="inputURL" placeholder="https://example.com" autocomplete="off" />

  <label><input type="checkbox" id="checkboxPrivate" /> Make link PRIVATE (requires access code)</label>

  <div id="privateCodeDiv" style="display:none;">
    <label for="inputAccessCode">Set access code (min 3 chars):</label>
    <input type="password" id="inputAccessCode" placeholder="Access code" autocomplete="off" />
  </div>

  <button id="btnGenerate">Generate Short Link & QR Code</button>

  <div id="message"></div>
  <div id="error"></div>

  <div id="qrcode"></div>

  <div id="linksList"></div>
</div>

<div id="accessOverlay">
  <div id="waitSpinner"></div>
  <h2>Checking for bots...</h2>
  <p id="accessMessage">Please wait 5 seconds.</p>
  <input type="password" id="accessCodeInput" placeholder="Enter access code" style="display:none;" autocomplete="off" />
  <button id="btnAccessSubmit" style="display:none;">Submit</button>
  <div id="accessError"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
  const inputURL = document.getElementById('inputURL');
  const checkboxPrivate = document.getElementById('checkboxPrivate');
  const privateCodeDiv = document.getElementById('privateCodeDiv');
  const inputAccessCode = document.getElementById('inputAccessCode');
  const btnGenerate = document.getElementById('btnGenerate');
  const message = document.getElementById('message');
  const error = document.getElementById('error');
  const qrcodeContainer = document.getElementById('qrcode');
  const linksList = document.getElementById('linksList');

  const accessOverlay = document.getElementById('accessOverlay');
  const waitSpinner = document.getElementById('waitSpinner');
  const accessMessage = document.getElementById('accessMessage');
  const accessCodeInput = document.getElementById('accessCodeInput');
  const btnAccessSubmit = document.getElementById('btnAccessSubmit');
  const accessError = document.getElementById('accessError');

  const STORAGE_KEY = 'gotolinkup_links';

  // Show/hide access code input
  checkboxPrivate.addEventListener('change', () => {
    privateCodeDiv.style.display = checkboxPrivate.checked ? 'block' : 'none';
  });

  // Validate URL
  function isValidURL(string) {
    try {
      new URL(string);
      return true;
    } catch (_) {
      return false;
    }
  }

  // Generate random short code (6 chars)
  function generateShortCode() {
    return Math.random().toString(36).slice(2, 8);
  }

  // Save link object to localStorage
  function saveLink(obj) {
    let links = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    links[obj.code] = obj;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(links));
  }

  // Load all links and show on page
  function loadLinks() {
    linksList.innerHTML = '<h3>Your saved links:</h3>';
    let links = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    if (Object.keys(links).length === 0) {
      linksList.innerHTML += '<p>No saved links yet.</p>';
      return;
    }
    for (const code in links) {
      const link = links[code];
      const linkEl = document.createElement('div');
      linkEl.className = 'link-item';
      const shortURL = `${window.location.origin}${window.location.pathname}?scode=${code}`;
      linkEl.innerHTML = `<strong>${code}</strong> - 
        <a href="${link.url}" target="_blank" style="color:#7efc82;">Original URL</a>
        <br>
        Short link: <a href="${shortURL}" target="_blank" style="color:#61dafb;">${shortURL}</a>
        ${link.private ? '<span class="private-tag">[PRIVATE]</span>' : ''}
        <span class="copy-btn" title="Copy short link" data-clip="${shortURL}">ðŸ“‹ Copy</span>
      `;
      linksList.appendChild(linkEl);
    }

    // Copy functionality
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.onclick = () => {
        const text = btn.getAttribute('data-clip');
        navigator.clipboard.writeText(text).then(() => {
          alert('Short link copied!');
        });
      };
    });
  }

  // Generate QR code for original URL
  function generateQRCode(text) {
    qrcodeContainer.innerHTML = '';
    QRCode.toCanvas(qrcodeContainer, text, { width: 180 }, err => {
      if (err) console.error(err);
    });
  }

  // Generate button click
  btnGenerate.addEventListener('click', () => {
    message.textContent = '';
    error.textContent = '';
    qrcodeContainer.innerHTML = '';

    const url = inputURL.value.trim();
    if (!isValidURL(url)) {
      error.textContent = 'Please enter a valid URL.';
      return;
    }

    const isPrivate = checkboxPrivate.checked;
    const accessCode = inputAccessCode.value.trim();

    if (isPrivate && accessCode.length < 3) {
      error.textContent = 'Access code must be at least 3 characters.';
      return;
    }

    const shortCode = generateShortCode();

    const linkObj = {
      code: shortCode,
      url: url,
      private: isPrivate,
      accessCode: isPrivate ? accessCode : null,
      createdAt: Date.now()
    };

    saveLink(linkObj);

    generateQRCode(url);

    message.innerHTML = `Link created!<br>
      Short URL: <a href="?scode=${shortCode}" target="_blank">${window.location.origin}${window.location.pathname}?scode=${shortCode}</a>`;

    inputURL.value = '';
    checkboxPrivate.checked = false;
    privateCodeDiv.style.display = 'none';
    inputAccessCode.value = '';

    loadLinks();
  });

  // On page load, check if ?scode= param exists
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  function startAccessFlow(code) {
    // Hide main app, show overlay
    document.getElementById('app').style.display = 'none';
    accessOverlay.classList.add('active');

    let links = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    const link = links[code];
    if (!link) {
      accessMessage.textContent = 'Link not found.';
      waitSpinner.style.display = 'none';
      return;
    }

    // Start anti-bot wait 5 seconds
    let wait = 5;
    accessMessage.textContent = `Please wait ${wait} seconds (anti-bot check)...`;
    accessCodeInput.style.display = 'none';
    btnAccessSubmit.style.display = 'none';
    accessError.textContent = '';
    waitSpinner.style.display = 'block';

    const timer = setInterval(() => {
      wait--;
      if (wait > 0) {
        accessMessage.textContent = `Please wait ${wait} seconds (anti-bot check)...`;
      } else {
        clearInterval(timer);
        waitSpinner.style.display = 'none';

        if (link.private) {
          accessMessage.textContent = 'This link is PRIVATE. Enter access code:';
          accessCodeInput.style.display = 'block';
          btnAccessSubmit.style.display = 'inline-block';
          accessCodeInput.focus();
        } else {
          // Redirect immediately
          window.location.href = link.url;
        }
      }
    }, 1000);

    btnAccessSubmit.onclick = () => {
      accessError.textContent = '';
      if (accessCodeInput.value === link.accessCode) {
        window.location.href = link.url;
      } else {
        accessError.textContent = 'Incorrect access code.';
      }
    };

    accessCodeInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        btnAccessSubmit.click();
      }
    });
  }

  // Init
  loadLinks();

  const scode = getQueryParam('scode');
  if (scode) {
    startAccessFlow(scode);
  }
</script>

</body>
</html>
